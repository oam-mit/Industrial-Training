import json
from context_identification.settings import BASE_DIR
import os
from gensim.models import LdaMulticore
from gensim.corpora import Dictionary
from gensim.parsing.preprocessing import STOPWORDS
import nltk
from nltk.tokenize import word_tokenize
from nltk.stem import PorterStemmer, WordNetLemmatizer
nltk.data.path.append('.')
nltk.download('punkt')
nltk.download('wordnet')

mapping = {
    0: ['bobilli-vijay-kumar', 0.250625],
    1: ['life-style', 'life-style.food.drinks-corner'],
    2: ['friendship-day-2012', 0.33416668],
    3: ['nrs-2003', 0.50125],
    4: ['tendulkar', 0.50125],
    5: ['world-cancer-day', 0.33416668],
    6: ['sports.cricket.india-domestic', 0.4005],
    7: ['corporate-espionage-in-ministries'],
    8: ['iraq-hostage-drama', 0.250625],
    9: ['regional', 0.50125],
    10: ['politics'],
    11: ['tech-news-news-wire'],
    12: ['mocktale', 0.50125],
    13: ['manchester-city', 0.6675],
    14: ['janmashtami.janmashtami-stories', 0.500625],
    15: ['city.hyderabad', 0.6675],
    16: ['mahashivratri', 0.50125],
    17: ['astrology.horoscope', 0.6675],
    18: ['videos', 0.50125],
    19: ['health'],
    20: ['tech.computing', 0.33416668],
    21: ['friendship-day', 0.50125],
    22: ['valentines-day', 0.50125],
    23: ['city.surat', 0.33416668],
    24: ['deep.pathankot-terrorist-attack.questions-and-answers', 0.1432143],
    25: ['cricket', 0.50125],
    26: ['himachal-pradesh', 0.64605266],
    27: ['corporate-espionage-in-ministries', 0.250625],
    28: ['weather'],
    29: ['tottenham-hotspur', 0.50125],
    30: ['stats.trivia', 0.50125],
    31: ['the-himalayan-blunder', 0.33416668],
    32: ['city.bareilly', 0.33416668],
    33: ['speak-out', 0.50125],
    34: ['books'],
    35: ['disaster-management'],
    36: ['teachers-day', 0.50125],
    37: ['miscellaneous'],
    38: ['down-memory-lane', 0.33416668],
    39: ['city.salem', 0.33416668],
    40: ['city.jodhpur', 0.6675],
    41: ['christmas', 0.50125],
    42: ['speech'],
    43: ['city.madurai', 0.6675],
    44: ['wigan-athletic', 0.50125],
    45: ['blackburn-rovers', 0.50125],
    46: ['city.agra', 0.6675],
    47: ['education', 0.50125],
    48: ['government'],
    49: ['muharram', 0.50125],
    50: ['drivers'],
    51: ['crime'],
    52: ['player-profile', 0.33416668],
    53: ['miscellaneous'],
    54: ['competition'],
    55: ['entertainment-industry'],
    56: ['elections.assembly-elections.goa', 0.500625],
    57: ['entertainment.hindi.music.singer-of-the-week', 0.16708332],
    58: ['entertainment', ],
    59: ['tamil-nadu', 0.6675],
    60: ['life-style.health-fitness.every-heart-counts', 0.1432143],
    61: ['crime'],
    62: ['world-aids-day', 0.33416668],
    63: ['sino-indian-ties', 0.33416668],
    64: ['city.nashik', 0.6675],
    65: ['life-style.relationships.soul-curry', 0.16708334],
    66: ['diwali-rituals', 0.33416668],
    67: ['border-issue'],
    68: ['crime'],
    69: ['raksha-bandhan-2013', 0.500625],
    70: ['city.indore', 0.6675],
    72: ['ciber-crime'],
    74: ['nagpur-pluses', 0.50125],
    75: ['war-on-iraq.opinion', 0.33416668],
    76: ['environment'],
    78: ['ad-links', 0.50125],
    79: ['agriculture'],
    80: ['also-read', 0.50125],
    81: ['city.ranchi', 0.33416668],
    82: ['crime'],
    83: ['city.lucknow', 0.6675],

    86: ['sports.football.indian-super-league.team-profiles', 0.1253125],
    87: ['chhattisgarh', 0.50125],

    89: ['city.hubballi', 0.6675],
    90: ['baroda', 0.50125],
    91: ['home', 0.50125],
    92: ['tech.how-to', 0.50125],
    93: ['city.bhubaneswar', 0.6675],
    94: ['crime'],
    95: ['top-headlines', 0.50125],
    97: ['entertainment.hindi.music.music-reviews', 0.33375],
    98: ['caste and religion'],
    99: ['good-day-good-news', 0.500625],
    100: ['timeline', 0.50125],
    101: ['indian politics'],
    103: ['entertainment'],
    105: ['stoke-city', 0.6675],
    108: ['border-security'],
    109: ['crime'],
    110: ['scorecard-and-statistics', 0.33416668],
    112: ['recipes', 0.50125],
    113: ['tv.news.english', 0.33416668],

    115: ['world-environment-day', 0.33416674],

    117: ['madhya-pradesh', 0.6675],
    118: ['gaming', 0.50125],

    121: ['city.coimbatore', 0.6675],

    123: ['city.amritsar', 0.6675],
    124: ['schedule', 0.50125],
    125: ['india-news', 0.6675],
    126: ['campaign-trail', 0.33416668],
    127: ['donts', 0.50125],

    130: ['2008-in-pictures', 0.33416668],
    131: ['entertainment.marathi', 0.33416668],

    133: ['sports.hockey.hockey-india-league', 0.4673542],
    135: ['life-style.parenting.teen', 0.20050001],
    138: ['photos', 0.50125],
    139: ['budget-2015.common-man', 0.250625],
    140: ['auto.launches', 0.33416668],
    141: ['sports.cricket.new-zealand-in-india', 0.4005],
    142: ['2013-the-year-sachin-bids-adieu.more-sports-2013', 0.32556596],
    143: ['vote-maadi', 0.50125],
    145: ['city.aurangabad', 0.6675],
    147: ['audi-cars', 0.33416668],
    149: ['arsenal', 0.50125],
    151: ['bachi-karkaria.erratica', 0.6675],
    153: ['business.india-business', 0.750625],
    154: ['haryana', 0.50125],
    160: ['city.raipur', 0.33416668],
    162: ['queens-baton-relay', 0.250625],
    163: ['pune', 0.50125],
    164: ['quickstir.lifestyle', 0.50125],
    165: ['auto.reviews', 0.33416668],
    168: ['food-facts', 0.33416668],
    169: ['unsw.study-at-unsw', 0.50125],
    171: ['life-style.fashion.celeb-style', 0.33372965],
    172: ['city', 0.50125],
    173: ['city.varanasi', 0.6675],
    175: ['commonwealth-games-2014.news', 0.20050004],
    176: ['birla-will-saga', 0.33416668],
    177: ['city.noida', 0.6675],
    178: ['city.rajkot', 0.6675],
    182: ['iit-bengaluru', 0.50125],
    184: ['bangalore', 0.50125],
    186: ['uttarakhand', 0.50125],
    188: ['city.meerut', 0.6675],
    189: ['city.puducherry', 0.6675],
    190: ['politics', 0.50125],
    193: ['sports.chess', 0.33416668],
    194: ['jaipur', 0.50125],
    196: ['entertainment.hindi.top-10', 0.33416668],
    197: ['auto.bikes', 0.33416668],
    200: ['advisory', 0.50125],
    201: ['venture-capital', 0.6675],
    204: ['city.gurgaon', 0.6675],
    205: ['jug-suraiya.second-opinion', 0.250625],
    207: ['aap-crisis', 0.50125],
    210: ['entertainment.kannada', 0.33416668],
    213: ['indian-challenges', 0.33416668],
    215: ['top-stories', 0.50125],
    216: ['other-racing.a1-gp', 0.50125],
    218: ['aston-villa', 0.50125],
    219: ['liverpool', 0.50125],
    221: ['asian-games-2014.india-at-incheon', 0.40050003],
    223: ['best-products.mobile-phones', 0.20050001],
    224: ['anti-terror-law', 0.33416668],
    225: ['gadgets-special', 0.33416668],
    226: ['people', 0.50125],
    227: ['sports.expert-column.sunil-gavaskar', 0.20050001],
    228: ['city.shillong', 0.6675],
    229: ['bihar', 0.50125],
    234: ['2011-top-slideshow', 0.50125],
    235: ['city.allahabad', 0.6675],
    236: ['sa-aiyar.swaminomics', 0.50125],
    237: ['city.visakhapatnam', 0.6675],
    238: ['gujarat-pluses', 0.50125],
    241: ['sports.cricket.india-in-england', 0.40049997],
    242: ['newcastle-united', 0.50125],
    244: ['jugular-vein', 0.50125],
    245: ['venues', 0.50125],
    246: ['city.vijayawada', 0.6675],
    247: ['reporters-diary', 0.33416668],
    248: ['odisha', 0.50125],
    250: ['rajasthan', 0.50125],
    251: ['questions-and-answers', 0.33416668],
    253: ['most-searched-products.todays-deals.amazon', 0.16708335],
    254: ['city.patna', 0.6675],
    256: ['bolton-wanderers', 0.50125],
    259: ['world.mad-mad-world', 0.6675],
    260: ['olympics', 0.50125],
    264: ['sports.tennis.top-stories.tennis-atp', 0.4005],
    265: ['dussehra', 0.50125],
    267: ['auto', 0.50125],
    268: ['india-challenges', 0.6675],
    269: ['life-style.health-fitness.health', 0.33375],
    270: ['best-products.fashion.accessories', 0.4005],
    273: ['analysis', 0.50125],
    276: ['sports.commonwealth-games', 0.250625],
    277: ['matches-results', 0.33416674],
    279: ['ambani', 0.50125],
    281: ['city.dehradun', 0.6675],
    283: ['lohri', 0.50125],
    285: ['profiles.india-profiles', 0.500625],
    288: ['hyundai-cars', 0.3341667],
    289: ['columbia-crash', 0.50125],
    290: ['city.amaravati', 0.6675],
    295: ['history', 0.50125],
    296: ['rupee-symbol-survey', 0.25062504],
    297: ['city.jind', 0.6675],
    298: ['poll-pourri', 0.50125],
    300: ['ahmedabad', 0.50125],
    301: ['pre-budget', 0.50125],
    303: ['chelsea', 0.50125],
    304: ['fathers-day.fathers-day-stories', 0.500625],
    308: ['city.mumbai', 0.6675],
    311: ['interviews', 0.50125],
    312: ['business.personal-finance', 0.250625],
    314: ['city.delhi', 0.6675],
    316: ['city.bhopal', 0.6675],
    318: ['nri.community', 0.50125],
    323: ['andhra-pradesh', 0.6675],
    324: ['spotlight', 0.50125],
    325: ['chevrolet-cars', 0.33416668],
    326: ['hay-festival', 0.50125],
    328: ['diwali', 0.50125],
    329: ['india-hopes', 0.6675],
    332: ['young-guns', 0.33416668],
    333: ['text-after-pic', 0.50125],
    334: ['city.cuttack', 0.6675],
    335: ['blogs', 0.50125],
    336: ['entertainment.hindi.theatre', 0.250625],
    337: ['city.kanpur', 0.6675],
    339: ['commonwealth-games-2014.india-at-glasgow', 0.31619427],
    343: ['life-style.parenting.toddler-year-and-beyond', 0.31289557],
    347: ['mahavir-jayanti.mahavir-jayanti-stories', 0.500625],
    348: ['city.chandigarh', 0.6675],
    350: ['city.jammu', 0.6675],
    351: ['city.srinagar', 0.6675],
    353: ['specials', 0.50125],
    354: ['first-look', 0.50125],
    356: ['city.mangaluru', 0.6675],
    358: ['air-pollution', 0.50125],
    359: ['life-style', 0.33416668],
    362: ['get-healthy-get-fit', 0.50125],
    365: ['bmw-cars', 0.50125],
    366: ['sports.cricket.india-in-south-africa', 0.5004167],
    367: ['delhis-century', 0.33416674],
    369: ['best-products.home-decor-and-garden.living-room-decor', 0.22250001],
    370: ['city.kolkata', 0.6675],
    372: ['missile-game', 0.33416674],
    373: ['humour.third-edit', 0.50125],
    374: ['life-style.food.food-features', 0.33375],
    375: ['apply-for', 0.50125],
    376: ['city.vadodara', 0.6675],
    377: ['it-services-news-wire', 0.250625],
    381: ['citizens-grievances', 0.33416668],
    382: ['entertainment.beauty-pageants.news', 0.20050004],
    383: ['lodge-a-complaint', 0.6675],
    384: ['movie-reviews', 0.33416668],
    385: ['republic-day', 0.50125],
    388: ['humour.social-humour', 0.50125],
    389: ['young-india-votes.from-the-states', 0.44193172],
    392: ['gurcharan-das.men-ideas', 0.50125],
    393: ['onam', 0.50125],
    396: ['santosh-desai.city-city-bang-bang', 0.5198877],
    398: ['sports.more-sports.others', 0.6675],
    399: ['maharashtra-pluses', 0.50125]}


class LDAModel():
    def __init__(self):
        self._model = LdaMulticore.load(os.path.join(
            BASE_DIR, 'lda/model/400_topics.model'))
        self._dictionary = Dictionary.load(
            os.path.join(BASE_DIR, 'lda/model/dictionary'))

    def __preprocess(self, sentence):
        stemmer = PorterStemmer()
        output = []
        tokenized_words = word_tokenize(sentence)

        for word in tokenized_words:
            if word not in STOPWORDS and len(word) > 3:
                word = stemmer.stem(
                    WordNetLemmatizer().lemmatize(word, pos='v'))
                output.append(word)

        return output

    def predict(self, input) -> list:
        new_doc = self.__preprocess(input)
        new_doc_bow = self._dictionary.doc2bow(new_doc)

        predictions = self._model.get_document_topics(new_doc_bow)
        prediction_labels = set()
        for prediction in predictions:
            if prediction[1] > 0.05:
                try:
                    prediction_label = mapping[int(prediction[0])][0]
                except:
                    prediction_label = 'miscellaneous'

                prediction_labels.add(prediction_label)

        return list(prediction_labels)
